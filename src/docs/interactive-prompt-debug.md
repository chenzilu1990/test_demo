# 交互式提示词组件调试与修复方案

## 问题概述

交互式提示词组件在使用过程中出现严重问题：
- 无法编辑内容
- 网页崩溃
- 性能严重下降

## 问题原因分析

经过代码审查，发现以下几个关键问题：

### 1. 文本差异计算算法过于复杂

在`useTextHandling.ts`中，用于计算文本差异和映射位置的算法非常复杂：
- `calculateChangeRatio`
- `findCommonSubstrings`
- `computeTextDiff`

这些算法在处理大量文本或复杂变化时可能导致性能瓶颈，甚至在某些边缘情况下进入无限循环。

### 2. 渲染逻辑复杂且缺乏优化

在`InteractiveContent.tsx`中：
- 每次文本变化都重新生成完整的React节点树
- 尽管使用了`useMemo`，但依赖项较多，可能导致频繁重新计算
- 当处理重叠选项时可能出现不可预期的行为

### 3. DOM操作与React状态不同步

在`contenteditable`模式下：
- 直接DOM操作与React状态更新之间存在竞争条件
- 选区保存和恢复在复杂操作时可能失败
- DOM和React状态不同步会导致UI不一致，甚至崩溃

## 解决方案

### 1. 创建简化版组件

创建了简化版的组件，专注于核心功能和稳定性：
- `useSimpleTextHandling.ts`: 简化的文本处理Hook
- `InteractivePromptSimple.tsx`: 简化版交互式提示词组件

### 2. 替换复杂算法

- 移除了复杂的差异计算和位置映射算法
- 采用更简单的处理方式，牺牲一些高级功能来确保基本稳定性
- 当检测到大的文本变化时，重置选项状态而不是尝试保持

### 3. 简化渲染方式

- 使用简单的正则替换而不是复杂的React节点树
- 使用`dangerouslySetInnerHTML`来渲染格式化内容(仅在可控内容下使用)
- 减少内部状态的数量和复杂度

### 4. 改进错误处理

- 添加更多的try-catch块来捕获潜在错误
- 提供清晰的错误信息和降级处理
- 在关键操作中设置超时保护

## 测试方法

创建了独立的测试页面`/src/pages/interactive-prompt-test.tsx`：
- 包含简化的测试环境
- 提供基本功能测试步骤
- 添加调试信息显示
- 可切换`contenteditable`模式以测试不同模式下的稳定性

## 后续优化方向

1. **性能监控**：添加性能监控代码，记录关键操作的执行时间
2. **渐进式增强**：在简化版本稳定后，逐步添加高级功能
3. **单元测试**：为各个组件和功能添加单元测试，特别是边缘情况
4. **替代技术**：考虑使用库如Slate.js等专业编辑器框架替代自定义实现
5. **分阶段加载**：考虑将复杂功能拆分为可动态加载的模块

## 如何使用

1. 使用`/src/pages/interactive-prompt-test.tsx`页面进行测试
2. 在主应用中，可以先使用`InteractivePromptSimple`组件替代原有组件
3. 在确认简化版本工作稳定后，再考虑逐步恢复高级功能 